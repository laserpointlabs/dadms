<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Modeler Debug Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            height: 80vh;
            border: 1px solid #ccc;
        }

        .canvas {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        .properties {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
        }

        .property-field {
            margin-bottom: 15px;
        }

        .property-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
            color: #555;
        }

        .property-field input,
        .property-field select,
        .property-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        .property-field input:focus,
        .property-field select:focus,
        .property-field textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .debug {
            margin-top: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>BPMN Modeler Debug Test</h1>
    <p>This test loads the actual BPMN.js modeler and tests the properties panel integration.</p>

    <div class="container">
        <div class="canvas">
            <h3>BPMN Canvas</h3>
            <div id="canvas" style="height: 400px; border: 1px solid #ddd;"></div>
            <div style="margin-top: 10px;">
                <button onclick="testElementSelection()">Test Element Selection</button>
                <button onclick="testPropertyUpdate()">Test Property Update</button>
                <button onclick="saveXML()">Save XML</button>
            </div>
        </div>

        <div class="properties">
            <h3>Properties Panel</h3>
            <div id="properties-content">
                <p>Select an element to edit its properties</p>
            </div>
            <div class="debug" id="debug-output">
                <strong>Debug Output:</strong><br>
                <span id="debug-content">Initializing...</span>
            </div>
        </div>
    </div>

    <script>
        let modeler = null;
        let selectedElement = null;
        let isUpdating = false;
        let editingField = null;

        // Simple BPMN XML for testing
        const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1" name="Start">
      <bpmn:outgoing>Flow_1</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:task id="Task_1" name="First Task" camunda:type="external" camunda:topic="test-topic">
      <bpmn:incoming>Flow_1</bpmn:incoming>
      <bpmn:outgoing>Flow_2</bpmn:outgoing>
      <bpmn:extensionElements>
        <camunda:properties>
          <camunda:property name="service.type" value="assistant" />
          <camunda:property name="service.name" value="test-service" />
          <camunda:property name="service.version" value="1.0" />
        </camunda:properties>
      </bpmn:extensionElements>
    </bpmn:task>
    <bpmn:endEvent id="EndEvent_1" name="End">
      <bpmn:incoming>Flow_2</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1" />
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="EndEvent_1" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="152" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="158" y="145" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
        <dc:Bounds x="240" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="265" y="105" width="50" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="392" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="398" y="145" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="188" y="120" />
        <di:waypoint x="240" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="340" y="120" />
        <di:waypoint x="392" y="120" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        async function initializeModeler() {
            try {
                log('Loading BPMN.js CSS...', 'info');

                // Load CSS
                if (!document.querySelector('link[href*="bpmn-js"]')) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'https://unpkg.com/bpmn-js@18.6.2/dist/assets/diagram-js.css';
                    document.head.appendChild(link);

                    const link2 = document.createElement('link');
                    link2.rel = 'stylesheet';
                    link2.href = 'https://unpkg.com/bpmn-js@18.6.2/dist/assets/bpmn-font/css/bpmn.css';
                    document.head.appendChild(link2);
                }

                log('Loading BPMN.js library...', 'info');

                // Load BPMN.js
                if (!window.BpmnJS) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://unpkg.com/bpmn-js@18.6.2/dist/bpmn-modeler.production.min.js';
                        script.onload = () => resolve();
                        script.onerror = (error) => reject(error);
                        document.head.appendChild(script);
                    });
                }

                log('Creating modeler...', 'info');

                // Create modeler
                const BpmnModeler = window.BpmnJS?.BpmnModeler || window.BpmnJS;
                if (!BpmnModeler) {
                    throw new Error('Failed to load BPMN Modeler');
                }

                modeler = new BpmnModeler({
                    container: document.getElementById('canvas'),
                    width: '100%',
                    height: '100%'
                });

                log('Modeler created successfully', 'success');

                // Import XML
                log('Importing test XML...', 'info');
                await modeler.importXML(testXML);
                log('XML imported successfully', 'success');

                // Add event listeners
                modeler.on('element.click', (event) => {
                    const element = event.element;
                    if (element) {
                        selectElement(element);
                    }
                });

                modeler.on('selection.changed', (event) => {
                    const selection = event.newSelection;
                    if (selection && selection.length > 0) {
                        selectElement(selection[0]);
                    } else {
                        clearSelection();
                    }
                });

                log('Modeler initialized successfully', 'success');

            } catch (error) {
                log('Error initializing modeler: ' + error.message, 'error');
                console.error('Modeler initialization error:', error);
            }
        }

        function selectElement(element) {
            selectedElement = element;
            log('Element selected: ' + element.id + ' (' + element.type + ')', 'info');
            updatePropertiesPanel();
        }

        function clearSelection() {
            selectedElement = null;
            log('Selection cleared', 'info');
            document.getElementById('properties-content').innerHTML = '<p>Select an element to edit its properties</p>';
        }

        function updatePropertiesPanel() {
            if (!selectedElement) return;

            const businessObject = selectedElement.businessObject;
            const isProcess = businessObject.$type === 'bpmn:Process';

            let html = `
                <div class="property-group">
                    <h4>${isProcess ? 'Process Properties' : 'Basic Properties'}</h4>
                    <div class="property-field">
                        <label>Name</label>
                        <input type="text" id="element-name" value="${businessObject.name || ''}" 
                               onchange="handleInputChange('name', this.value)"
                               onfocus="handleInputFocus('name')"
                               onblur="handleInputBlur('name')">
                    </div>
                    <div class="property-field">
                        <label>ID</label>
                        <input type="text" id="element-id" value="${businessObject.id || ''}" 
                               onchange="handleInputChange('id', this.value)"
                               onfocus="handleInputFocus('id')"
                               onblur="handleInputBlur('id')">
                    </div>
                </div>
            `;

            if (!isProcess) {
                html += `
                    <div class="property-group">
                        <h4>Implementation</h4>
                        <div class="property-field">
                            <label>Type</label>
                            <select id="implementation-type" 
                                    onchange="handleInputChange('implementation.type', this.value)"
                                    onfocus="handleInputFocus('implementation.type')"
                                    onblur="handleInputBlur('implementation.type')">
                                <option value="">Select type</option>
                                <option value="external" ${businessObject.get('camunda:type') === 'external' ? 'selected' : ''}>External</option>
                                <option value="java" ${businessObject.get('camunda:type') === 'java' ? 'selected' : ''}>Java</option>
                                <option value="expression" ${businessObject.get('camunda:type') === 'expression' ? 'selected' : ''}>Expression</option>
                            </select>
                        </div>
                        <div class="property-field">
                            <label>Topic</label>
                            <input type="text" id="implementation-topic" value="${businessObject.get('camunda:topic') || ''}" 
                                   onchange="handleInputChange('implementation.topic', this.value)"
                                   onfocus="handleInputFocus('implementation.topic')"
                                   onblur="handleInputBlur('implementation.topic')">
                        </div>
                    </div>
                    <div class="property-group">
                        <h4>Extension Properties</h4>
                        <div class="property-field">
                            <label>Service Type</label>
                            <input type="text" id="service-type" value="${getExtensionProperty(businessObject, 'service.type')}" 
                                   onchange="handleInputChange('extensions.service.type', this.value)"
                                   onfocus="handleInputFocus('extensions.service.type')"
                                   onblur="handleInputBlur('extensions.service.type')">
                        </div>
                        <div class="property-field">
                            <label>Service Name</label>
                            <input type="text" id="service-name" value="${getExtensionProperty(businessObject, 'service.name')}" 
                                   onchange="handleInputChange('extensions.service.name', this.value)"
                                   onfocus="handleInputFocus('extensions.service.name')"
                                   onblur="handleInputBlur('extensions.service.name')">
                        </div>
                        <div class="property-field">
                            <label>Service Version</label>
                            <input type="text" id="service-version" value="${getExtensionProperty(businessObject, 'service.version')}" 
                                   onchange="handleInputChange('extensions.service.version', this.value)"
                                   onfocus="handleInputFocus('extensions.service.version')"
                                   onblur="handleInputBlur('extensions.service.version')">
                        </div>
                    </div>
                `;
            }

            document.getElementById('properties-content').innerHTML = html;
        }

        function getExtensionProperty(businessObject, propertyName) {
            try {
                const extensionElements = businessObject.get('extensionElements');
                if (extensionElements) {
                    const properties = extensionElements.get('camunda:properties');
                    if (properties) {
                        const property = properties.find(prop => prop.get('name') === propertyName);
                        return property ? property.get('value') : '';
                    }
                }
            } catch (error) {
                log('Error getting extension property: ' + error.message, 'error');
            }
            return '';
        }

        function handleInputChange(propertyPath, value) {
            log('Input change: ' + propertyPath + ' = ' + value, 'info');
        }

        function handleInputFocus(propertyPath) {
            editingField = propertyPath;
            log('Focus: ' + propertyPath, 'info');
        }

        async function handleInputBlur(propertyPath) {
            if (!selectedElement || !modeler || isUpdating) {
                editingField = null;
                log('Blur cancelled - not ready', 'error');
                return;
            }

            isUpdating = true;
            editingField = null;
            log('Saving: ' + propertyPath, 'info');

            try {
                const modeling = modeler.get('modeling');
                const businessObject = selectedElement.businessObject;

                if (!modeling || !businessObject) {
                    log('Required BPMN.js services not available', 'error');
                    return;
                }

                // Get the current value from the input
                const input = document.getElementById(getInputId(propertyPath));
                const value = input ? input.value : '';

                // Update the model
                if (propertyPath === 'name') {
                    modeling.updateProperties(selectedElement, { name: value });
                } else if (propertyPath === 'id') {
                    modeling.updateProperties(selectedElement, { id: value });
                } else if (propertyPath.startsWith('implementation.')) {
                    const implProp = propertyPath.split('.')[1];
                    if (implProp === 'type') {
                        modeling.updateProperties(selectedElement, { 'camunda:type': value });
                    } else if (implProp === 'topic') {
                        modeling.updateProperties(selectedElement, { 'camunda:topic': value });
                    }
                } else if (propertyPath.startsWith('extensions.')) {
                    const extProp = propertyPath.split('.')[1];
                    updateExtensionProperty(businessObject, extProp, value);
                }

                log('Saved: ' + propertyPath + ' = ' + value, 'success');

            } catch (error) {
                log('Error saving property: ' + error.message, 'error');
                console.error('Property save error:', error);
            } finally {
                isUpdating = false;
            }
        }

        function getInputId(propertyPath) {
            const pathParts = propertyPath.split('.');
            if (pathParts[0] === 'extensions') {
                return pathParts[1].replace('.', '-');
            } else if (pathParts[0] === 'implementation') {
                return 'implementation-' + pathParts[1];
            } else {
                return 'element-' + pathParts[0];
            }
        }

        function updateExtensionProperty(businessObject, propertyName, value) {
            try {
                const moddle = modeler.get('moddle');
                if (!moddle) {
                    log('Moddle not available for extension property update', 'error');
                    return;
                }

                let extensionElements = businessObject.get('extensionElements');
                if (!extensionElements) {
                    extensionElements = moddle.create('bpmn:ExtensionElements');
                    businessObject.set('extensionElements', extensionElements);
                }

                let properties = extensionElements.get('camunda:properties');
                if (!properties) {
                    properties = moddle.create('camunda:Properties');
                    extensionElements.set('camunda:properties', properties);
                }

                let property = properties.find(prop => prop.get('name') === propertyName);

                if (value.trim()) {
                    if (!property) {
                        property = moddle.create('camunda:Property');
                        property.set('name', propertyName);
                        properties.push(property);
                    }
                    property.set('value', value);
                } else {
                    if (property) {
                        const index = properties.indexOf(property);
                        if (index > -1) {
                            properties.splice(index, 1);
                        }
                    }
                }
            } catch (error) {
                log('Error updating extension property: ' + error.message, 'error');
                console.error('Extension property update error:', error);
            }
        }

        function testElementSelection() {
            log('Testing element selection...', 'info');
            if (modeler) {
                const elementRegistry = modeler.get('elementRegistry');
                const task = elementRegistry.get('Task_1');
                if (task) {
                    selectElement(task);
                } else {
                    log('Task_1 not found', 'error');
                }
            } else {
                log('Modeler not initialized', 'error');
            }
        }

        function testPropertyUpdate() {
            log('Testing property update...', 'info');
            if (selectedElement) {
                const modeling = modeler.get('modeling');
                modeling.updateProperties(selectedElement, { name: 'Updated Task Name' });
                updatePropertiesPanel();
                log('Property updated successfully', 'success');
            } else {
                log('No element selected', 'error');
            }
        }

        async function saveXML() {
            if (!modeler) {
                log('Modeler not initialized', 'error');
                return;
            }

            try {
                const result = await modeler.saveXML({ format: true });
                log('XML saved successfully', 'success');
                console.log('Generated XML:', result.xml);
            } catch (error) {
                log('Error saving XML: ' + error.message, 'error');
            }
        }

        function log(message, type = 'info') {
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            const logEntry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            debugContent.innerHTML += logEntry;
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        // Initialize when page loads
        window.addEventListener('load', initializeModeler);
    </script>
</body>

</html>