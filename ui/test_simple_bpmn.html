<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple BPMN Test</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.6.2/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.6.2/dist/assets/bpmn-font/css/bpmn.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            height: 600px;
            border: 1px solid #ccc;
        }

        .canvas {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        .properties {
            width: 300px;
            padding: 20px;
            background: #f5f5f5;
        }

        .property-field {
            margin-bottom: 10px;
        }

        .property-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .property-field input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
        }

        .info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>Simple BPMN Test</h1>

    <div class="info">
        <strong>Test Instructions:</strong>
        <ol>
            <li>Check if BPMN diagram loads correctly</li>
            <li>Click on elements to see if selection works</li>
            <li>Try editing properties</li>
            <li>Check console for any errors</li>
        </ol>
    </div>

    <div class="container">
        <div id="canvas" class="canvas"></div>
        <div class="properties">
            <h3>Properties Panel</h3>
            <div id="properties-content">
                <p>Select an element to edit its properties</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/bpmn-js@18.6.2/dist/bpmn-modeler.production.min.js"></script>
    <script>
        let modeler;
        let selectedElement = null;

        // Simple test BPMN XML
        const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
    <bpmn:process id="Process_1" isExecutable="false">
        <bpmn:startEvent id="StartEvent_1" name="Start">
            <bpmn:outgoing>Flow_1</bpmn:outgoing>
        </bpmn:startEvent>

        <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1" />

        <bpmn:task id="Task_1" name="Test Task">
            <bpmn:incoming>Flow_1</bpmn:incoming>
            <bpmn:outgoing>Flow_2</bpmn:outgoing>
        </bpmn:task>

        <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="EndEvent_1" />

        <bpmn:endEvent id="EndEvent_1" name="End">
            <bpmn:incoming>Flow_2</bpmn:incoming>
        </bpmn:endEvent>
    </bpmn:process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
            <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
                <dc:Bounds x="152" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
                <di:waypoint x="188" y="250" />
                <di:waypoint x="240" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
                <dc:Bounds x="240" y="210" width="100" height="80" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
                <di:waypoint x="340" y="250" />
                <di:waypoint x="392" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
                <dc:Bounds x="392" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        async function initModeler() {
            try {
                const BpmnModeler = window.BpmnJS?.BpmnModeler || window.BpmnJS;

                if (!BpmnModeler) {
                    throw new Error('BPMN Modeler not loaded');
                }

                console.log('Creating BPMN modeler...');

                // Simple modeler configuration
                modeler = new BpmnModeler({
                    container: '#canvas',
                    width: '100%',
                    height: '100%'
                });

                console.log('Importing XML...');

                // Import test XML
                await modeler.importXML(testXML);
                console.log('BPMN modeler initialized successfully');

                // Add event listeners
                modeler.on('element.click', (event) => {
                    const element = event.element;
                    if (element) {
                        selectElement(element);
                    }
                });

                modeler.on('selection.changed', (event) => {
                    const selection = event.newSelection;
                    if (selection && selection.length > 0) {
                        selectElement(selection[0]);
                    } else {
                        clearSelection();
                    }
                });

                // Add change listener
                modeler.on('commandStack.changed', async () => {
                    try {
                        const result = await modeler.saveXML({ format: true });
                        console.log('XML updated successfully');
                    } catch (error) {
                        console.error('Error saving XML:', error);
                    }
                });

            } catch (error) {
                console.error('Error initializing modeler:', error);
                document.getElementById('properties-content').innerHTML =
                    '<p style="color: red;">Error initializing BPMN modeler: ' + error.message + '</p>';
            }
        }

        function selectElement(element) {
            selectedElement = element;
            updatePropertiesPanel();
        }

        function clearSelection() {
            selectedElement = null;
            document.getElementById('properties-content').innerHTML =
                '<p>Select an element to edit its properties</p>';
        }

        function updatePropertiesPanel() {
            if (!selectedElement) return;

            const businessObject = selectedElement.businessObject;
            const isProcess = businessObject.$type === 'bpmn:Process';

            let html = `
                <div class="property-field">
                    <label>Name</label>
                    <input type="text" id="element-name" value="${businessObject.name || ''}" 
                           onchange="updateProperty('name', this.value)">
                </div>
                <div class="property-field">
                    <label>ID</label>
                    <input type="text" id="element-id" value="${businessObject.id || ''}" 
                           onchange="updateProperty('id', this.value)">
                </div>
            `;

            document.getElementById('properties-content').innerHTML = html;
        }

        function updateProperty(propertyPath, value) {
            if (!selectedElement || !modeler) return;

            try {
                const modeling = modeler.get('modeling');
                modeling.updateProperties(selectedElement, { [propertyPath]: value });
                console.log('Property updated:', propertyPath, value);
            } catch (error) {
                console.error('Error updating property:', error);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initModeler);
    </script>
</body>

</html>