<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Service Task Properties Panel - Final Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .canvas-container {
            flex: 1;
            background: #f7f7f7;
            position: relative;
        }

        .properties-container {
            width: 350px;
            background: white;
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        .properties-panel {
            flex: 1;
            overflow: auto;
        }

        .xml-view {
            height: 250px;
            border-top: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        .xml-header {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            font-size: 14px;
        }

        .xml-content {
            flex: 1;
            padding: 10px;
            overflow: auto;
            background: #f9f9f9;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }

        .status-bar {
            padding: 8px 15px;
            background: #e7f3ff;
            border-bottom: 1px solid #b3d9ff;
            font-size: 12px;
            color: #0066cc;
        }

        .status-bar.error {
            background: #f8d7da;
            border-bottom: 1px solid #f5c6cb;
            color: #721c24;
        }

        .bjs-container {
            height: 100%;
        }

        /* Custom styles for better properties panel appearance */
        .bio-properties-panel-group {
            border-bottom: 1px solid #e0e0e0;
        }

        .bio-properties-panel-group-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .bio-properties-panel-entry {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .bio-properties-panel-entry:last-child {
            border-bottom: none;
        }

        .bio-properties-panel-entry label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }

        .bio-properties-panel-entry input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .bio-properties-panel-entry input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }
    </style> <!-- BPMN.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-font/css/bpmn-embedded.css">
</head>

<body>
    <div class="container">
        <div class="canvas-container">
            <div class="status-bar" id="status">Initializing BPMN modeler...</div>
            <div id="canvas"></div>
        </div>
        <div class="properties-container">
            <div id="properties-panel" class="properties-panel"></div>
            <div class="xml-view">
                <div class="xml-header">Generated XML</div>
                <div class="xml-content" id="xml-output">Loading...</div>
            </div>
        </div>
    </div>

    <!-- BPMN.js -->
    <script src="https://unpkg.com/bpmn-js@17.11.1/dist/bpmn-modeler.production.min.js"></script>

    <script>
        // Initial BPMN XML with Service Task and extension properties
        const initialXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
                   xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                   xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
                   xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
                   xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                   xmlns:service="http://example.com/service"
                   id="Definitions_1" 
                   targetNamespace="http://example.com/bpmn">
  <bpmn2:process id="Process_1" isExecutable="false">
    <bpmn2:startEvent id="StartEvent_1">
      <bpmn2:outgoing>SequenceFlow_1</bpmn2:outgoing>
    </bpmn2:startEvent>
    <bpmn2:serviceTask id="ServiceTask_1" name="Sample Service Task" service:type="REST" service:name="UserService" service:version="1.0">
      <bpmn2:incoming>SequenceFlow_1</bpmn2:incoming>
      <bpmn2:outgoing>SequenceFlow_2</bpmn2:outgoing>
    </bpmn2:serviceTask>
    <bpmn2:userTask id="UserTask_1" name="Review Task">
      <bpmn2:incoming>SequenceFlow_2</bpmn2:incoming>
      <bpmn2:outgoing>SequenceFlow_3</bpmn2:outgoing>
    </bpmn2:userTask>
    <bpmn2:endEvent id="EndEvent_1">
      <bpmn2:incoming>SequenceFlow_3</bpmn2:incoming>
    </bpmn2:endEvent>
    <bpmn2:sequenceFlow id="SequenceFlow_1" sourceRef="StartEvent_1" targetRef="ServiceTask_1"/>
    <bpmn2:sequenceFlow id="SequenceFlow_2" sourceRef="ServiceTask_1" targetRef="UserTask_1"/>
    <bpmn2:sequenceFlow id="SequenceFlow_3" sourceRef="UserTask_1" targetRef="EndEvent_1"/>
  </bpmn2:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds height="36.0" width="36.0" x="173.0" y="102.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_1_di" bpmnElement="ServiceTask_1">
        <dc:Bounds x="260" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_1_di" bpmnElement="UserTask_1">
        <dc:Bounds x="410" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds height="36.0" width="36.0" x="562.0" y="102.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1_di" bpmnElement="SequenceFlow_1">
        <di:waypoint xsi:type="dc:Point" x="209" y="120"/>
        <di:waypoint xsi:type="dc:Point" x="260" y="120"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_2_di" bpmnElement="SequenceFlow_2">
        <di:waypoint xsi:type="dc:Point" x="360" y="120"/>
        <di:waypoint xsi:type="dc:Point" x="410" y="120"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_3_di" bpmnElement="SequenceFlow_3">
        <di:waypoint xsi:type="dc:Point" x="510" y="120"/>
        <di:waypoint xsi:type="dc:Point" x="562" y="120"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn2:definitions>`;

        let modeler;
        let selectedElement = null;

        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'status-bar error' : 'status-bar';
        }

        // Function to get extension property value
        function getExtensionProperty(element, propertyName) {
            if (!element || !element.businessObject) return '';
            const attrs = element.businessObject.$attrs || {};
            return attrs[propertyName] || '';
        }

        // Function to update extension property
        function updateExtensionProperty(element, propertyName, value) {
            if (!element || !element.businessObject) return;

            const modeling = modeler.get('modeling');
            const attrs = Object.assign({}, element.businessObject.$attrs || {});

            if (value && value.trim() !== '') {
                attrs[propertyName] = value;
            } else {
                delete attrs[propertyName];
            }

            modeling.updateProperties(element, {
                $attrs: attrs
            });

            updateXMLDisplay();
        }

        // Function to update basic properties
        function updateBasicProperty(propertyName, value) {
            if (!selectedElement) return;

            const modeling = modeler.get('modeling');
            const properties = {};
            properties[propertyName] = value;

            modeling.updateProperties(selectedElement, properties);
            updateXMLDisplay();
        }

        // Function to update properties panel
        function updatePropertiesPanel() {
            const propertiesPanel = document.getElementById('properties-panel');

            if (!selectedElement) {
                propertiesPanel.innerHTML = '<div style="padding: 20px; color: #666;">Select an element to view properties</div>';
                return;
            }

            const businessObject = selectedElement.businessObject;
            const isServiceTask = businessObject.$type === 'bpmn:ServiceTask';

            let html = `
                <div class="bio-properties-panel-group">
                    <div class="bio-properties-panel-group-header">General</div>
                    <div class="bio-properties-panel-entry">
                        <label>Name</label>
                        <input type="text" value="${businessObject.name || ''}" 
                               onchange="updateBasicProperty('name', this.value)">
                    </div>
                    <div class="bio-properties-panel-entry">
                        <label>ID</label>
                        <input type="text" value="${businessObject.id || ''}" 
                               onchange="updateBasicProperty('id', this.value)">
                    </div>
                </div>
            `;

            if (isServiceTask) {
                html += `
                    <div class="bio-properties-panel-group">
                        <div class="bio-properties-panel-group-header">Service Properties</div>
                        <div class="bio-properties-panel-entry">
                            <label>Service Type</label>
                            <input type="text" value="${getExtensionProperty(selectedElement, 'service:type')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:type', this.value)">
                        </div>
                        <div class="bio-properties-panel-entry">
                            <label>Service Name</label>
                            <input type="text" value="${getExtensionProperty(selectedElement, 'service:name')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:name', this.value)">
                        </div>
                        <div class="bio-properties-panel-entry">
                            <label>Service Version</label>
                            <input type="text" value="${getExtensionProperty(selectedElement, 'service:version')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:version', this.value)">
                        </div>
                    </div>
                `;
            }

            propertiesPanel.innerHTML = html;
        }

        // Function to select an element
        function selectElement(element) {
            selectedElement = element;
            const businessObject = element.businessObject;
            updateStatus(`Selected: ${businessObject.$type} (${businessObject.id})`);
            updatePropertiesPanel();
        }
        this._propertiesPanel = propertiesPanel;
        this._translate = translate;
        this._modeling = modeling;

        // Register the provider with lower priority
        propertiesPanel.registerProvider(500, this);

        this.getGroups = function (element) {
            const self = this;
            return function (groups) {
                // Only show service properties for service tasks
                if (element.type === 'bpmn:ServiceTask') {
                    groups.push(self._createServiceGroup(element));
                }
                return groups;
            };
        };

        this._createServiceGroup = function (element) {
            const self = this;
            return {
                id: 'service',
                label: self._translate('Service Properties'),
                entries: [
                    self._createServiceTypeEntry(element),
                    self._createServiceNameEntry(element),
                    self._createServiceVersionEntry(element)
                ]
            };
        };

        this._createServiceTypeEntry = function (element) {
            const self = this;
            return {
                id: 'service-type',
                element: element,
                component: function (props) {
                    return self._createTextEntry(
                        props.element,
                        'service-type',
                        self._translate('Service Type'),
                        'service:type'
                    );
                },
                isEdited: function () { return false; }
            };
        };

        this._createServiceNameEntry = function (element) {
            const self = this;
            return {
                id: 'service-name',
                element: element,
                component: function (props) {
                    return self._createTextEntry(
                        props.element,
                        'service-name',
                        self._translate('Service Name'),
                        'service:name'
                    );
                },
                isEdited: function () { return false; }
            };
        };

        this._createServiceVersionEntry = function (element) {
            const self = this;
            return {
                id: 'service-version',
                element: element,
                component: function (props) {
                    return self._createTextEntry(
                        props.element,
                        'service-version',
                        self._translate('Service Version'),
                        'service:version'
                    );
                },
                isEdited: function () { return false; }
            };
        };

        // Helper function to create a text entry
        this._createTextEntry = function (element, id, label, propertyName) {
            const self = this;
            const container = document.createElement('div');
            container.className = 'bio-properties-panel-entry';

            const labelEl = document.createElement('label');
            labelEl.textContent = label;
            labelEl.setAttribute('for', id);

            const input = document.createElement('input');
            input.type = 'text';
            input.id = id;
            input.value = self._getExtensionProperty(element, propertyName) || '';

            // Add debounced input handler
            let timeout;
            input.addEventListener('input', function (e) {
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    self._updateExtensionProperty(element, propertyName, e.target.value);
                }, 300);
            });

            // Update input value when element changes
            const updateInput = function () {
                const currentValue = self._getExtensionProperty(element, propertyName) || '';
                if (input.value !== currentValue) {
                    input.value = currentValue;
                }
            };

            container._updateInput = updateInput;

            container.appendChild(labelEl);
            container.appendChild(input);

            return container;
        };

        this._getExtensionProperty = function (element, propertyName) {
            if (!element || !element.businessObject) {
                return '';
            }

            const attrs = element.businessObject.$attrs || {};
            return attrs[propertyName] || '';
        };

        this._updateExtensionProperty = function (element, propertyName, value) {
            if (!element || !element.businessObject) {
                return;
            }

            const attrs = Object.assign({}, element.businessObject.$attrs || {});

            if (value && value.trim() !== '') {
                attrs[propertyName] = value;
            } else {
                delete attrs[propertyName];
            }

            this._modeling.updateProperties(element, {
                $attrs: attrs
            });
        };
        }

        ServicePropertiesProvider.$inject = ['propertiesPanel', 'translate', 'modeling'];

        // Function to update XML display
        function updateXMLDisplay() {
            if (!modeler) return;

            modeler.saveXML({ format: true }).then(function (result) {
                document.getElementById('xml-output').textContent = result.xml;
            }).catch(function (err) {
                console.error('Error saving XML:', err);
                document.getElementById('xml-output').textContent = 'Error generating XML: ' + err.message;
            });
        }

        // Initialize the modeler
        async function initModeler() {
            try {
                updateStatus('Checking dependencies...');

                // Check if libraries are loaded
                if (typeof BpmnJS === 'undefined') {
                    throw new Error('BPMN.js library not loaded');
                }

                if (typeof BpmnPropertiesPanelModule === 'undefined') {
                    throw new Error('Properties Panel module not loaded');
                }

                updateStatus('Creating BPMN modeler...');

                modeler = new BpmnJS({
                    container: '#canvas',
                    propertiesPanel: {
                        parent: '#properties-panel'
                    },
                    additionalModules: [
                        BpmnPropertiesPanelModule,
                        BpmnPropertiesProviderModule,
                        {
                            __init__: ['servicePropertiesProvider'],
                            servicePropertiesProvider: ['type', ServicePropertiesProvider]
                        }
                    ],
                    moddleExtensions: {
                        service: serviceModdleDescriptor
                    }
                });

                updateStatus('Importing BPMN diagram...');

                await modeler.importXML(initialXML);

                updateStatus('âœ“ Ready! Click on the Service Task to edit its properties.');

                // Auto-select the service task
                setTimeout(function () {
                    const elementRegistry = modeler.get('elementRegistry');
                    const selection = modeler.get('selection');
                    const serviceTask = elementRegistry.get('ServiceTask_1');

                    if (serviceTask) {
                        selection.select(serviceTask);
                    }
                }, 100);

                // Listen for changes to update XML display
                modeler.on('commandStack.changed', function () {
                    updateXMLDisplay();

                    // Update input fields
                    const propertiesPanel = document.getElementById('properties-panel');
                    const entries = propertiesPanel.querySelectorAll('.bio-properties-panel-entry');

                    entries.forEach(function (entry) {
                        if (entry._updateInput) {
                            entry._updateInput();
                        }
                    });
                });

                updateXMLDisplay();

            } catch (error) {
                updateStatus('Error: ' + error.message, true);
                console.error('Modeler initialization error:', error);
                document.getElementById('xml-output').textContent = 'Failed to initialize: ' + error.message;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initModeler);

        // Debug function
        window.debugModeler = function () {
            console.log('Modeler:', modeler);
            const selection = modeler ? modeler.get('selection') : null;
            const selected = selection ? selection.get() : [];
            console.log('Selected elements:', selected);

            if (selected.length > 0) {
                console.log('Selected element details:', selected[0]);
                console.log('Business object:', selected[0].businessObject);
                console.log('Attributes:', selected[0].businessObject.$attrs);
            }
        };
    </script>
</body>

</html>