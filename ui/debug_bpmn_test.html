<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Debug Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            height: 80vh;
            border: 1px solid #ccc;
        }

        .canvas {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        .properties {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
        }

        .debug {
            margin-top: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>BPMN Debug Test</h1>
    <div class="container">
        <div class="canvas">
            <h3>BPMN Canvas</h3>
            <div id="canvas" style="height: 400px; border: 1px solid #ddd;"></div>
            <button onclick="testSelection()">Test Selection</button>
        </div>
        <div class="properties">
            <h3>Properties Panel</h3>
            <div id="properties-content">Select an element</div>
            <div class="debug" id="debug-output">
                <strong>Debug:</strong><br>
                <span id="debug-content">Initializing...</span>
            </div>
        </div>
    </div>

    <script>
        let modeler = null;
        let selectedElement = null;

        const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" id="Definitions_1">
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:task id="Task_1" name="Test Task" camunda:type="external" camunda:topic="test-topic">
      <bpmn:extensionElements>
        <camunda:properties>
          <camunda:property name="service.type" value="assistant" />
          <camunda:property name="service.name" value="test-service" />
        </camunda:properties>
      </bpmn:extensionElements>
    </bpmn:task>
  </bpmn:process>
</bpmn:definitions>`;

        async function init() {
            try {
                log('Loading BPMN.js...');

                // Load CSS
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/bpmn-js@18.6.2/dist/assets/diagram-js.css';
                document.head.appendChild(link);

                const link2 = document.createElement('link');
                link2.rel = 'stylesheet';
                link2.href = 'https://unpkg.com/bpmn-js@18.6.2/dist/assets/bpmn-font/css/bpmn.css';
                document.head.appendChild(link2);

                // Load JS
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/bpmn-js@18.6.2/dist/bpmn-modeler.production.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                log('Creating modeler...');
                const BpmnModeler = window.BpmnJS?.BpmnModeler || window.BpmnJS;
                modeler = new BpmnModeler({ container: document.getElementById('canvas') });

                log('Importing XML...');
                await modeler.importXML(testXML);
                log('XML imported successfully', 'success');

                // Add listeners
                modeler.on('element.click', (event) => {
                    if (event.element) {
                        selectElement(event.element);
                    }
                });

                log('Modeler ready', 'success');

            } catch (error) {
                log('Error: ' + error.message, 'error');
                console.error(error);
            }
        }

        function selectElement(element) {
            selectedElement = element;
            log('Selected: ' + element.id);
            updatePanel();
        }

        function updatePanel() {
            if (!selectedElement) return;

            const bo = selectedElement.businessObject;
            const html = `
                <div>
                    <label>Name: <input id="name" value="${bo.name || ''}" onblur="updateProperty('name', this.value)"></label><br>
                    <label>ID: <input id="id" value="${bo.id || ''}" onblur="updateProperty('id', this.value)"></label><br>
                    <label>Type: <input id="type" value="${bo.get('camunda:type') || ''}" onblur="updateProperty('camunda:type', this.value)"></label><br>
                    <label>Topic: <input id="topic" value="${bo.get('camunda:topic') || ''}" onblur="updateProperty('camunda:topic', this.value)"></label><br>
                    <label>Service Type: <input id="service-type" value="${getExtProp(bo, 'service.type')}" onblur="updateExtProp('service.type', this.value)"></label><br>
                    <label>Service Name: <input id="service-name" value="${getExtProp(bo, 'service.name')}" onblur="updateExtProp('service.name', this.value)"></label>
                </div>
            `;
            document.getElementById('properties-content').innerHTML = html;
        }

        function getExtProp(bo, name) {
            try {
                const ext = bo.get('extensionElements');
                if (ext) {
                    const props = ext.get('camunda:properties');
                    if (props) {
                        const prop = props.find(p => p.get('name') === name);
                        return prop ? prop.get('value') : '';
                    }
                }
            } catch (e) {
                log('Error getting ext prop: ' + e.message, 'error');
            }
            return '';
        }

        function updateProperty(name, value) {
            if (!selectedElement || !modeler) return;

            try {
                const modeling = modeler.get('modeling');
                modeling.updateProperties(selectedElement, { [name]: value });
                log('Updated ' + name + ' = ' + value, 'success');
            } catch (e) {
                log('Error updating ' + name + ': ' + e.message, 'error');
            }
        }

        function updateExtProp(name, value) {
            if (!selectedElement || !modeler) return;

            try {
                const moddle = modeler.get('moddle');
                const bo = selectedElement.businessObject;

                let ext = bo.get('extensionElements');
                if (!ext) {
                    ext = moddle.create('bpmn:ExtensionElements');
                    bo.set('extensionElements', ext);
                }

                let props = ext.get('camunda:properties');
                if (!props) {
                    props = moddle.create('camunda:Properties');
                    ext.set('camunda:properties', props);
                }

                let prop = props.find(p => p.get('name') === name);
                if (value.trim()) {
                    if (!prop) {
                        prop = moddle.create('camunda:Property');
                        prop.set('name', name);
                        props.push(prop);
                    }
                    prop.set('value', value);
                } else if (prop) {
                    const index = props.indexOf(prop);
                    if (index > -1) props.splice(index, 1);
                }

                log('Updated ext prop ' + name + ' = ' + value, 'success');
            } catch (e) {
                log('Error updating ext prop ' + name + ': ' + e.message, 'error');
            }
        }

        function testSelection() {
            if (modeler) {
                const registry = modeler.get('elementRegistry');
                const task = registry.get('Task_1');
                if (task) {
                    selectElement(task);
                } else {
                    log('Task_1 not found', 'error');
                }
            }
        }

        function log(msg, type = 'info') {
            const content = document.getElementById('debug-content');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            content.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
            content.scrollTop = content.scrollHeight;
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>