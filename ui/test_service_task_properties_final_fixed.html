<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Service Task Properties Panel - Professional Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .canvas-container {
            flex: 1;
            background: #f7f7f7;
            position: relative;
        }

        .properties-container {
            width: 350px;
            background: white;
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        .properties-panel {
            flex: 1;
            overflow: auto;
        }

        .xml-view {
            height: 250px;
            border-top: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        .xml-header {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            font-size: 14px;
        }

        .xml-content {
            flex: 1;
            padding: 10px;
            overflow: auto;
            background: #f9f9f9;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }

        .status-bar {
            padding: 8px 15px;
            background: #e7f3ff;
            border-bottom: 1px solid #b3d9ff;
            font-size: 12px;
            color: #0066cc;
        }

        .status-bar.error {
            background: #f8d7da;
            border-bottom: 1px solid #f5c6cb;
            color: #721c24;
        }

        .bjs-container {
            height: 100%;
        }

        /* Professional properties panel styling */
        .bio-properties-panel-group {
            border-bottom: 1px solid #e0e0e0;
        }

        .bio-properties-panel-group-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .bio-properties-panel-entry {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .bio-properties-panel-entry:last-child {
            border-bottom: none;
        }

        .bio-properties-panel-entry label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }

        .bio-properties-panel-entry input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .bio-properties-panel-entry input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="canvas-container">
            <div class="status-bar" id="status">Initializing BPMN modeler...</div>
            <div id="canvas"></div>
        </div>
        <div class="properties-container">
            <div id="properties-panel" class="properties-panel">
                <div class="empty-state">Select an element to view properties</div>
            </div>
            <div class="xml-view">
                <div class="xml-header">Generated XML</div>
                <div class="xml-content" id="xml-output">Loading...</div>
            </div>
        </div>
    </div>

    <!-- BPMN.js -->
    <script src="https://unpkg.com/bpmn-js@17.11.1/dist/bpmn-modeler.production.min.js"></script>

    <script>
        let modeler;
        let selectedElement = null;

        // Test BPMN XML with Service Task
        const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    xmlns:service="http://example.com/service"
    id="Definitions_test"
    targetNamespace="http://bpmn.io/schema/bpmn">
    <bpmn:process id="TestProcess" name="Test Process" isExecutable="true">
        <bpmn:startEvent id="StartEvent_1" name="Start">
            <bpmn:outgoing>Flow_1</bpmn:outgoing>
        </bpmn:startEvent>

        <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="ServiceTask_1" />

        <bpmn:serviceTask id="ServiceTask_1" name="Sample Service Task" service:type="REST" service:name="UserService" service:version="1.0">
            <bpmn:incoming>Flow_1</bpmn:incoming>
            <bpmn:outgoing>Flow_2</bpmn:outgoing>
        </bpmn:serviceTask>

        <bpmn:sequenceFlow id="Flow_2" sourceRef="ServiceTask_1" targetRef="EndEvent_1" />

        <bpmn:endEvent id="EndEvent_1" name="End">
            <bpmn:incoming>Flow_2</bpmn:incoming>
        </bpmn:endEvent>
    </bpmn:process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="TestProcess">
            <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
                <dc:Bounds x="152" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
                <di:waypoint x="188" y="250" />
                <di:waypoint x="240" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="ServiceTask_1_di" bpmnElement="ServiceTask_1">
                <dc:Bounds x="240" y="210" width="100" height="80" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
                <di:waypoint x="340" y="250" />
                <di:waypoint x="392" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
                <dc:Bounds x="392" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        function updateStatus(message, type = 'success') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type === 'error' ? 'status-bar error' : 'status-bar';
        }

        function updateXMLView() {
            if (!modeler) return;

            modeler.saveXML({ format: true }).then(result => {
                document.getElementById('xml-output').textContent = result.xml;
            }).catch(error => {
                document.getElementById('xml-output').textContent = 'Error: ' + error.message;
            });
        }

        function getExtensionProperty(element, propertyName) {
            if (!element || !element.businessObject) return '';
            const attrs = element.businessObject.$attrs || {};
            return attrs[propertyName] || '';
        }

        function updateExtensionProperty(element, propertyName, value) {
            if (!element || !element.businessObject) return;

            const modeling = modeler.get('modeling');
            const attrs = Object.assign({}, element.businessObject.$attrs || {});

            if (value && value.trim() !== '') {
                attrs[propertyName] = value;
            } else {
                delete attrs[propertyName];
            }

            modeling.updateProperties(element, {
                $attrs: attrs
            });

            updateXMLView();
        }

        function updatePropertiesPanel() {
            const propertiesPanel = document.getElementById('properties-panel');

            if (!selectedElement) {
                propertiesPanel.innerHTML = '<div class="empty-state">Select an element to view properties</div>';
                return;
            }

            const businessObject = selectedElement.businessObject;
            const isServiceTask = businessObject.$type === 'bpmn:ServiceTask';

            let html = `
                <div class="bio-properties-panel-group">
                    <div class="bio-properties-panel-group-header">General</div>
                    <div class="bio-properties-panel-entry">
                        <label>Name</label>
                        <input type="text" value="${businessObject.name || ''}" 
                               onchange="updateBasicProperty('name', this.value)">
                    </div>
                    <div class="bio-properties-panel-entry">
                        <label>ID</label>
                        <input type="text" value="${businessObject.id || ''}" 
                               onchange="updateBasicProperty('id', this.value)">
                    </div>
                </div>
            `;

            if (isServiceTask) {
                html += `
                    <div class="bio-properties-panel-group">
                        <div class="bio-properties-panel-group-header">Service Properties</div>
                        <div class="bio-properties-panel-entry">
                            <label>Service Type</label>
                            <input type="text" value="${getExtensionProperty(selectedElement, 'service:type')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:type', this.value)">
                        </div>
                        <div class="bio-properties-panel-entry">
                            <label>Service Name</label>
                            <input type="text" value="${getExtensionProperty(selectedElement, 'service:name')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:name', this.value)">
                        </div>
                        <div class="bio-properties-panel-entry">
                            <label>Service Version</label>
                            <input type="text" value="${getExtensionProperty(selectedElement, 'service:version')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:version', this.value)">
                        </div>
                    </div>
                `;
            }

            propertiesPanel.innerHTML = html;
        }

        function updateBasicProperty(propertyName, value) {
            if (!selectedElement) return;

            const modeling = modeler.get('modeling');
            const properties = {};
            properties[propertyName] = value;

            modeling.updateProperties(selectedElement, properties);
            updateXMLView();
        }

        function selectElement(element) {
            selectedElement = element;
            const businessObject = element.businessObject;
            updateStatus(`Selected: ${businessObject.$type} (${businessObject.id})`);
            updatePropertiesPanel();
        }

        async function initModeler() {
            try {
                updateStatus('Initializing BPMN modeler...', 'success');

                // Check if BPMN.js loaded
                if (typeof BpmnJS === 'undefined') {
                    throw new Error('BPMN.js library not loaded');
                }

                modeler = new BpmnJS({
                    container: '#canvas',
                    width: '100%',
                    height: '100%'
                });

                updateStatus('Importing BPMN diagram...', 'success');

                await modeler.importXML(testXML);

                updateStatus('BPMN modeler ready! Click on elements to edit properties.', 'success');

                // Add event listeners
                modeler.on('element.click', (event) => {
                    selectElement(event.element);
                });

                modeler.on('selection.changed', (event) => {
                    if (event.newSelection && event.newSelection.length > 0) {
                        selectElement(event.newSelection[0]);
                    }
                });

                // Auto-select the service task
                setTimeout(() => {
                    const elementRegistry = modeler.get('elementRegistry');
                    const serviceTask = elementRegistry.get('ServiceTask_1');
                    if (serviceTask) {
                        const selection = modeler.get('selection');
                        selection.select(serviceTask);
                        selectElement(serviceTask);
                    }
                }, 100);

                updateXMLView();

            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
                console.error('Modeler initialization error:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initModeler);

        // Add global debug function
        window.debugModeler = function () {
            console.log('Modeler:', modeler);
            console.log('Selected element:', selectedElement);
            if (selectedElement) {
                console.log('Business object:', selectedElement.businessObject);
                console.log('Attributes:', selectedElement.businessObject.$attrs);
            }
        };
    </script>
</body>

</html>