<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Modeler - Working Properties</title>

    <!-- BPMN.js CSS - must be loaded first -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-font/css/bpmn.css" />

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .toggle-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .main-container {
            display: flex;
            gap: 20px;
            height: 90vh;
        }

        .canvas-container {
            flex: 2;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .canvas {
            width: 100%;
            height: 100%;
        }

        /* Ensure bpmn.io palette is styled properly */
        .djs-palette {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            left: 20px !important;
            top: 20px !important;
        }

        .djs-palette .entry {
            border-radius: 3px;
        }

        .djs-palette .entry:hover {
            background: #e9ecef;
        }

        /* Ensure palette icons are visible */
        .djs-palette .entry div {
            color: #333;
        }

        /* Remove conflicting palette styles */
        .canvas-container .djs-palette {
            position: absolute;
            z-index: 100;
        }

        .properties {
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .property-group h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .property-field {
            margin-bottom: 15px;
        }

        .property-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 12px;
        }

        .property-field input,
        .property-field select,
        .property-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .property-field textarea {
            min-height: 60px;
            resize: vertical;
        }

        .property-field select {
            background: white;
        }

        .xml-editor {
            width: 100%;
            height: 100%;
            padding: 15px;
            border: none;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            box-sizing: border-box;
            resize: none;
            background: #f8f9fa;
            color: #333;
            border-radius: 4px;
            outline: none;
            overflow: auto;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .xml-editor:focus {
            background: #ffffff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .xml-view {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .element-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }

        .element-info h3 {
            margin: 0 0 5px 0;
            color: #1976d2;
            font-size: 14px;
        }

        .element-info p {
            margin: 0;
            color: #424242;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn:hover {
            background: #e9ecef;
        }

        .btn.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .btn.primary:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>BPMN Modeler - Working Properties</h1>
        <div class="view-toggle">
            <button class="toggle-btn active" onclick="switchView('diagram')">Diagram View</button>
            <button class="toggle-btn" onclick="switchView('xml')">XML View</button>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn primary" onclick="createNewDiagram()">New Diagram</button>
        <button class="btn" onclick="exportDiagram()">Export BPMN</button>
        <button class="btn" onclick="clearModel()">Clear All</button>
        <button class="btn" onclick="createTestTask()">Create Test Task</button>
    </div>

    <div id="status" class="status">Loading BPMN modeler...</div>

    <div class="main-container">
        <!-- Canvas Container -->
        <div class="canvas-container">
            <div id="canvas" class="canvas"></div>
            <textarea id="xml-editor" class="xml-editor hidden"></textarea>
        </div>

        <!-- Properties Panel -->
        <div class="properties">
            <div id="properties-content">
                <p>Select a BPMN element to edit its properties</p>
            </div>
        </div>
    </div>

    <div class="xml-view">
        <strong>Current XML:</strong>
        <pre id="xml-output">Loading...</pre>
    </div>

    <!-- BPMN.js -->
    <script src="https://unpkg.com/bpmn-js@17.11.1/dist/bpmn-modeler.production.min.js"></script>

    <script>
        let modeler;
        let selectedElement = null;
        let currentView = 'diagram';

        // Empty BPMN XML template
        const emptyXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    xmlns:service="http://example.com/service"
    id="Definitions_1"
    targetNamespace="http://bpmn.io/schema/bpmn">
    <bpmn:process id="Process_1" name="Process 1" isExecutable="true">
        <bpmn:startEvent id="StartEvent_1" name="Start">
            <bpmn:outgoing>Flow_1</bpmn:outgoing>
        </bpmn:startEvent>

        <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="EndEvent_1" />

        <bpmn:endEvent id="EndEvent_1" name="End">
            <bpmn:incoming>Flow_1</bpmn:incoming>
        </bpmn:endEvent>
    </bpmn:process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
            <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
                <dc:Bounds x="152" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
                <di:waypoint x="188" y="250" />
                <di:waypoint x="392" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
                <dc:Bounds x="392" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        function updateStatus(message, type = 'success') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function updateXMLView() {
            if (!modeler) return;

            modeler.saveXML({ format: true }).then(result => {
                document.getElementById('xml-output').textContent = result.xml;
                if (currentView === 'xml') {
                    document.getElementById('xml-editor').value = result.xml;
                }
            }).catch(error => {
                document.getElementById('xml-output').textContent = 'Error: ' + error.message;
            });
        }

        function switchView(view) {
            currentView = view;
            const canvas = document.getElementById('canvas');
            const xmlEditor = document.getElementById('xml-editor');
            const properties = document.querySelector('.properties');
            const diagramBtn = document.querySelector('.toggle-btn[onclick="switchView(\'diagram\')"]');
            const xmlBtn = document.querySelector('.toggle-btn[onclick="switchView(\'xml\')"]');

            if (view === 'diagram') {
                canvas.classList.remove('hidden');
                xmlEditor.classList.add('hidden');
                properties.classList.remove('hidden');
                diagramBtn.classList.add('active');
                xmlBtn.classList.remove('active');
                updateStatus('Switched to Diagram View', 'success');
            } else if (view === 'xml') {
                canvas.classList.add('hidden');
                xmlEditor.classList.remove('hidden');
                properties.classList.add('hidden');
                diagramBtn.classList.remove('active');
                xmlBtn.classList.add('active');

                // Sync current XML to editor
                if (modeler) {
                    modeler.saveXML({ format: true }).then(result => {
                        document.getElementById('xml-editor').value = result.xml;
                        updateStatus('Switched to XML View', 'success');
                    }).catch(error => {
                        updateStatus('Error loading XML: ' + error.message, 'error');
                    });
                }
            }
        }

        function createNewDiagram() {
            if (modeler) {
                modeler.importXML(emptyXML).then(() => {
                    updateStatus('New diagram created', 'success');
                    updateXMLView();
                }).catch(error => {
                    updateStatus('Error creating new diagram: ' + error.message, 'error');
                });
            }
        }

        function exportDiagram() {
            if (!modeler) return;

            modeler.saveXML({ format: true }).then(result => {
                const blob = new Blob([result.xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bpmn-diagram.bpmn';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                updateStatus('Diagram exported successfully', 'success');
            }).catch(error => {
                updateStatus('Export error: ' + error.message, 'error');
            });
        }

        function clearModel() {
            if (confirm('Are you sure you want to clear the entire model? This cannot be undone.')) {
                if (modeler) {
                    modeler.importXML(emptyXML).then(() => {
                        updateStatus('Model cleared', 'success');
                        updateXMLView();
                        selectedElement = null;
                        updatePropertiesPanel();
                    }).catch(error => {
                        updateStatus('Error clearing model: ' + error.message, 'error');
                    });
                }
            }
        }

        function createTestTask() {
            if (!modeler) return;

            const modeling = modeler.get('modeling');
            const elementFactory = modeler.get('elementFactory');
            const elementRegistry = modeler.get('elementRegistry');

            // Get the process
            const process = elementRegistry.get('Process_1');
            if (!process) {
                console.log('Process not found');
                return;
            }

            // Create a service task
            const serviceTask = elementFactory.createShape({
                type: 'bpmn:ServiceTask',
                id: 'TestServiceTask_1',
                name: 'Test Service Task'
            });

            // Add it to the process
            modeling.createShape(serviceTask, { x: 200, y: 200 }, process);

            // Select it
            const selection = modeler.get('selection');
            selection.select(serviceTask);
            selectElement(serviceTask);

            console.log('Test service task created and selected');
            updateStatus('Test service task created', 'success');
        }

        // Proper property update functions using BPMN.js modeling service
        function updateBasicProperty(propertyName, value) {
            if (!selectedElement || !modeler) return;

            const modeling = modeler.get('modeling');

            try {
                // Handle documentation as a special case
                if (propertyName === 'documentation') {
                    const bpmnFactory = modeler.get('bpmnFactory');
                    const documentation = bpmnFactory.create('bpmn:Documentation', {
                        text: value
                    });

                    modeling.updateProperties(selectedElement, {
                        documentation: [documentation]
                    });
                } else {
                    // Handle other basic properties
                    modeling.updateProperties(selectedElement, {
                        [propertyName]: value
                    });
                }

                // Force XML update
                setTimeout(() => {
                    updateXMLView();
                    updateStatus(`Updated ${propertyName} property`, 'success');
                }, 10);

            } catch (error) {
                console.error('Error updating property:', error);
                updateStatus(`Error updating ${propertyName}: ${error.message}`, 'error');
            }
        }

        function updateExtensionProperty(element, propertyName, value) {
            if (!element || !element.businessObject || !modeler) return;

            const modeling = modeler.get('modeling');

            try {
                // Get current attributes
                const currentAttrs = element.businessObject.$attrs || {};
                const newAttrs = { ...currentAttrs };

                if (value && value.trim() !== '') {
                    newAttrs[propertyName] = value;
                } else {
                    delete newAttrs[propertyName];
                }

                // Update the element with new attributes
                modeling.updateProperties(element, {
                    $attrs: newAttrs
                });

                // Force XML update
                setTimeout(() => {
                    updateXMLView();
                    updateStatus(`Updated ${propertyName} property`, 'success');
                }, 10);

            } catch (error) {
                console.error('Error updating extension property:', error);
                updateStatus(`Error updating ${propertyName}: ${error.message}`, 'error');
            }
        }

        function getExtensionProperty(element, propertyName) {
            if (!element || !element.businessObject) return '';
            const attrs = element.businessObject.$attrs || {};
            return attrs[propertyName] || '';
        }

        function updatePropertiesPanel() {
            if (!selectedElement) {
                document.getElementById('properties-content').innerHTML =
                    '<p>Select a BPMN element to edit its properties</p>';
                return;
            }

            const businessObject = selectedElement.businessObject;
            const elementType = businessObject.$type;
            const elementId = businessObject.id;
            const elementName = businessObject.name || '';

            // Determine element category
            const isServiceTask = elementType === 'bpmn:ServiceTask';
            const isScriptTask = elementType === 'bpmn:ScriptTask';
            const isUserTask = elementType === 'bpmn:UserTask';
            const isTask = elementType === 'bpmn:Task';

            let html = `
                <div class="element-info">
                    <h3>${elementType.replace('bpmn:', '')}</h3>
                    <p>ID: ${elementId}</p>
                </div>
                
                <div class="property-group">
                    <h4>Basic Properties</h4>
                    <div class="property-field">
                        <label>Name</label>
                        <input type="text" id="element-name" value="${elementName}" 
                               onchange="updateBasicProperty('name', this.value)">
                    </div>
                    <div class="property-field">
                        <label>ID</label>
                        <input type="text" id="element-id" value="${elementId}" 
                               onchange="updateBasicProperty('id', this.value)">
                    </div>
                    <div class="property-field">
                        <label>Element Type</label>
                        <input type="text" value="${elementType}" readonly style="background:#f5f5f5;">
                    </div>
                </div>
            `;

            // Service Task specific properties
            if (isServiceTask) {
                html += `
                    <div class="property-group">
                        <h4>Service Task Properties</h4>
                        <div class="property-field">
                            <label>Service Type</label>
                            <select id="service-type" onchange="updateExtensionProperty(selectedElement, 'service:serviceType', this.value)">
                                <option value="">Select Type</option>
                                <option value="REST" ${getExtensionProperty(selectedElement, 'service:serviceType') === 'REST' ? 'selected' : ''}>REST</option>
                                <option value="SOAP" ${getExtensionProperty(selectedElement, 'service:serviceType') === 'SOAP' ? 'selected' : ''}>SOAP</option>
                                <option value="JAVA" ${getExtensionProperty(selectedElement, 'service:serviceType') === 'JAVA' ? 'selected' : ''}>JAVA</option>
                                <option value="EXPRESSION" ${getExtensionProperty(selectedElement, 'service:serviceType') === 'EXPRESSION' ? 'selected' : ''}>EXPRESSION</option>
                            </select>
                        </div>
                        <div class="property-field">
                            <label>Service Name</label>
                            <input type="text" id="service-name" 
                                   value="${getExtensionProperty(selectedElement, 'service:serviceName')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:serviceName', this.value)"
                                   placeholder="e.g., UserService">
                        </div>
                        <div class="property-field">
                            <label>Service Version</label>
                            <input type="text" id="service-version" 
                                   value="${getExtensionProperty(selectedElement, 'service:serviceVersion')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:serviceVersion', this.value)"
                                   placeholder="e.g., 1.0">
                        </div>
                        <div class="property-field">
                            <label>Endpoint URL</label>
                            <input type="text" id="service-endpoint" 
                                   value="${getExtensionProperty(selectedElement, 'service:serviceEndpoint')}" 
                                   onchange="updateExtensionProperty(selectedElement, 'service:serviceEndpoint', this.value)"
                                   placeholder="https://api.example.com/service">
                        </div>
                    </div>
                `;
            }

            document.getElementById('properties-content').innerHTML = html;
        }

        function selectElement(element) {
            selectedElement = element;
            const businessObject = element.businessObject;
            updateStatus(`Selected: ${businessObject.$type} (${businessObject.id})`, 'info');
            updatePropertiesPanel();
        }

        async function initModeler() {
            try {
                updateStatus('Initializing BPMN modeler...', 'info');

                // Check if BPMN.js loaded
                if (typeof BpmnJS === 'undefined') {
                    throw new Error('BPMN.js library not loaded');
                }

                modeler = new BpmnJS({
                    container: '#canvas'
                });

                updateStatus('Importing empty BPMN diagram...', 'info');

                await modeler.importXML(emptyXML);

                updateStatus('BPMN modeler ready! Use the palette on the left to add elements.', 'success');

                // Add event listeners
                modeler.on('element.click', (event) => {
                    selectElement(event.element);
                });

                modeler.on('selection.changed', (event) => {
                    if (event.newSelection && event.newSelection.length > 0) {
                        selectElement(event.newSelection[0]);
                    } else {
                        selectedElement = null;
                        updatePropertiesPanel();
                    }
                });

                modeler.on('element.changed', () => {
                    updateXMLView();
                });

                updateXMLView();

            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
                console.error('Modeler initialization error:', error);
                console.error('Error details:', error.stack);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initModeler);

        // Add global debug function
        window.debugModeler = function () {
            console.log('Modeler:', modeler);
            console.log('Selected element:', selectedElement);
            if (selectedElement) {
                console.log('Business object:', selectedElement.businessObject);
                console.log('Attributes:', selectedElement.businessObject.$attrs);
            }
            console.log('Current view:', currentView);
        };

        // Add global function to test property updates
        window.testPropertyUpdate = function () {
            if (!selectedElement) {
                console.log('No element selected');
                return;
            }

            console.log('Testing property update...');
            updateBasicProperty('name', 'Test Property Update ' + Date.now());
        };
    </script>
</body>

</html>