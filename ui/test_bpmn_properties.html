<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Properties Panel Test</title>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.6.2/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.6.2/dist/assets/bpmn-font/css/bpmn.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            height: 600px;
            border: 1px solid #ccc;
        }

        .canvas {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        .properties {
            width: 300px;
            padding: 20px;
            background: #f5f5f5;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-field {
            margin-bottom: 10px;
        }

        .property-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .property-field input,
        .property-field select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
        }

        .info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>BPMN Properties Panel Test</h1>

    <div class="info">
        <strong>Test Instructions:</strong>
        <ol>
            <li>Click on any BPMN element to select it</li>
            <li>Edit properties in the right panel</li>
            <li>Check the console for any errors</li>
            <li>Verify that extension properties are saved in the XML</li>
        </ol>
    </div>

    <div class="container">
        <div id="canvas" class="canvas"></div>
        <div class="properties">
            <h3>Properties Panel</h3>
            <div id="properties-content">
                <p>Select an element to edit its properties</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/bpmn-js@18.6.2/dist/bpmn-modeler.production.min.js"></script>
    <script>
        let modeler;
        let selectedElement = null;

        // Test BPMN XML with extension properties
        const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_test"
    targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.34.0"
    modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.20.0">
    <bpmn:process id="TestProcess" name="Test Process" isExecutable="true">
        <bpmn:startEvent id="StartEvent_1" name="Start">
            <bpmn:outgoing>Flow_1</bpmn:outgoing>
        </bpmn:startEvent>

        <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="ServiceTask_1" />

        <bpmn:serviceTask id="ServiceTask_1" name="Test Task" camunda:type="external" camunda:topic="test-topic">
            <bpmn:extensionElements>
                <camunda:properties>
                    <camunda:property name="service.type" value="assistant" />
                    <camunda:property name="service.name" value="test-service" />
                    <camunda:property name="service.version" value="1.0" />
                </camunda:properties>
            </bpmn:extensionElements>
            <bpmn:incoming>Flow_1</bpmn:incoming>
            <bpmn:outgoing>Flow_2</bpmn:outgoing>
        </bpmn:serviceTask>

        <bpmn:sequenceFlow id="Flow_2" sourceRef="ServiceTask_1" targetRef="EndEvent_1" />

        <bpmn:endEvent id="EndEvent_1" name="End">
            <bpmn:incoming>Flow_2</bpmn:incoming>
        </bpmn:endEvent>
    </bpmn:process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="TestProcess">
            <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
                <dc:Bounds x="152" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
                <di:waypoint x="188" y="250" />
                <di:waypoint x="240" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="ServiceTask_1_di" bpmnElement="ServiceTask_1">
                <dc:Bounds x="240" y="210" width="100" height="80" />
            </bpmndi:BPMNShape>

            <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
                <di:waypoint x="340" y="250" />
                <di:waypoint x="392" y="250" />
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
                <dc:Bounds x="392" y="232" width="36" height="36" />
            </bpmndi:BPMNShape>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

        async function initModeler() {
            try {
                const BpmnModeler = window.BpmnJS?.BpmnModeler || window.BpmnJS;

                if (!BpmnModeler) {
                    throw new Error('BPMN Modeler not loaded');
                }

                // Create modeler with Camunda extensions
                modeler = new BpmnModeler({
                    container: '#canvas',
                    width: '100%',
                    height: '100%',
                    moddleExtensions: {
                        camunda: {
                            name: 'Camunda',
                            uri: 'http://camunda.org/schema/1.0/bpmn',
                            prefix: 'camunda',
                            xml: {
                                tagAlias: 'lowerCase'
                            },
                            types: [
                                {
                                    name: 'Properties',
                                    isAbstract: true,
                                    extends: ['bpmn:BaseElement'],
                                    properties: [
                                        {
                                            name: 'properties',
                                            isMany: true,
                                            type: 'Property'
                                        }
                                    ]
                                },
                                {
                                    name: 'Property',
                                    isAbstract: true,
                                    extends: ['bpmn:BaseElement'],
                                    properties: [
                                        {
                                            name: 'name',
                                            type: 'String'
                                        },
                                        {
                                            name: 'value',
                                            type: 'String'
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                });

                // Import test XML
                await modeler.importXML(testXML);
                console.log('BPMN modeler initialized successfully');

                // Add event listeners
                modeler.on('element.click', (event) => {
                    const element = event.element;
                    if (element) {
                        selectElement(element);
                    }
                });

                modeler.on('selection.changed', (event) => {
                    const selection = event.newSelection;
                    if (selection && selection.length > 0) {
                        selectElement(selection[0]);
                    } else {
                        clearSelection();
                    }
                });

                // Add change listener
                modeler.on('commandStack.changed', async () => {
                    try {
                        const result = await modeler.saveXML({ format: true });
                        console.log('XML updated:', result.xml);
                    } catch (error) {
                        console.error('Error saving XML:', error);
                    }
                });

            } catch (error) {
                console.error('Error initializing modeler:', error);
                document.getElementById('properties-content').innerHTML =
                    '<p style="color: red;">Error initializing BPMN modeler: ' + error.message + '</p>';
            }
        }

        function selectElement(element) {
            selectedElement = element;
            updatePropertiesPanel();
        }

        function clearSelection() {
            selectedElement = null;
            document.getElementById('properties-content').innerHTML =
                '<p>Select an element to edit its properties</p>';
        }

        function updatePropertiesPanel() {
            if (!selectedElement) return;

            const businessObject = selectedElement.businessObject;
            const isProcess = businessObject.$type === 'bpmn:Process';

            let html = `
                <div class="property-group">
                    <h4>${isProcess ? 'Process Properties' : 'Basic Properties'}</h4>
                    <div class="property-field">
                        <label>Name</label>
                        <input type="text" id="element-name" value="${businessObject.name || ''}" 
                               onchange="updateProperty('name', this.value)">
                    </div>
                    <div class="property-field">
                        <label>ID</label>
                        <input type="text" id="element-id" value="${businessObject.id || ''}" 
                               onchange="updateProperty('id', this.value)">
                    </div>
                </div>
            `;

            if (!isProcess) {
                html += `
                    <div class="property-group">
                        <h4>Implementation</h4>
                        <div class="property-field">
                            <label>Type</label>
                            <select id="implementation-type" onchange="updateProperty('camunda:type', this.value)">
                                <option value="">Select type</option>
                                <option value="external" ${businessObject.get('camunda:type') === 'external' ? 'selected' : ''}>External</option>
                                <option value="java" ${businessObject.get('camunda:type') === 'java' ? 'selected' : ''}>Java</option>
                                <option value="expression" ${businessObject.get('camunda:type') === 'expression' ? 'selected' : ''}>Expression</option>
                            </select>
                        </div>
                        <div class="property-field">
                            <label>Topic</label>
                            <input type="text" id="implementation-topic" value="${businessObject.get('camunda:topic') || ''}" 
                                   onchange="updateProperty('camunda:topic', this.value)">
                        </div>
                    </div>

                    <div class="property-group">
                        <h4>Extension Properties</h4>
                        <div class="property-field">
                            <label>Service Type</label>
                            <input type="text" id="service-type" value="${getExtensionProperty(businessObject, 'service.type')}" 
                                   onchange="updateExtensionProperty('service.type', this.value)">
                        </div>
                        <div class="property-field">
                            <label>Service Name</label>
                            <input type="text" id="service-name" value="${getExtensionProperty(businessObject, 'service.name')}" 
                                   onchange="updateExtensionProperty('service.name', this.value)">
                        </div>
                        <div class="property-field">
                            <label>Service Version</label>
                            <input type="text" id="service-version" value="${getExtensionProperty(businessObject, 'service.version')}" 
                                   onchange="updateExtensionProperty('service.version', this.value)">
                        </div>
                    </div>
                `;
            }

            document.getElementById('properties-content').innerHTML = html;
        }

        function getExtensionProperty(businessObject, propertyName) {
            try {
                const extensionElements = businessObject.get('extensionElements');
                if (extensionElements) {
                    const properties = extensionElements.get('camunda:properties');
                    if (properties) {
                        const property = properties.find(prop => prop.get('name') === propertyName);
                        return property ? property.get('value') : '';
                    }
                }
            } catch (error) {
                console.warn('Error getting extension property:', error);
            }
            return '';
        }

        function updateProperty(propertyPath, value) {
            if (!selectedElement || !modeler) return;

            try {
                const modeling = modeler.get('modeling');
                modeling.updateProperties(selectedElement, { [propertyPath]: value });
                console.log('Property updated:', propertyPath, value);
            } catch (error) {
                console.error('Error updating property:', error);
            }
        }

        function updateExtensionProperty(propertyName, value) {
            if (!selectedElement || !modeler) return;

            try {
                const businessObject = selectedElement.businessObject;
                const moddle = modeler.get('moddle');

                let extensionElements = businessObject.get('extensionElements');
                if (!extensionElements) {
                    extensionElements = moddle.create('bpmn:ExtensionElements');
                    businessObject.set('extensionElements', extensionElements);
                }

                let properties = extensionElements.get('camunda:properties');
                if (!properties) {
                    properties = moddle.create('camunda:Properties');
                    extensionElements.set('camunda:properties', properties);
                }

                let property = properties.find(prop => prop.get('name') === propertyName);

                if (value.trim()) {
                    if (!property) {
                        property = moddle.create('camunda:Property');
                        property.set('name', propertyName);
                        properties.push(property);
                    }
                    property.set('value', value);
                } else {
                    if (property) {
                        const index = properties.indexOf(property);
                        if (index > -1) {
                            properties.splice(index, 1);
                        }
                    }
                }

                console.log('Extension property updated:', propertyName, value);
            } catch (error) {
                console.error('Error updating extension property:', error);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initModeler);
    </script>
</body>

</html>